#+Title: District-level male medical and traditional circumcision
#+Title: coverage and unmet need in sub-Saharan Africa
#+date: 18th June 2023
#+bibliography: library.bib 
#+options: toc:nil num:t d:nil author:nil
#+startup: latexpreview

# Load latex class, define page and text size
#+latex_class: article
#+latex_class_options: [a4paper, 12pt]

# load latex packages
#+latex_header: \usepackage{authblk} 
#+latex_header: \usepackage{breakcites}
#+latex_header: \usepackage{apacite}
#+latex_header: \usepackage{pifont}
#+latex_header: \usepackage{multirow}
#+latex_header: \usepackage[top=3cm, bottom=3cm, left=3cm, right=3cm]{geometry} % define (reduced) margin size
#+latex_header: \usepackage[parfill]{parskip} % insert whitespace between new paragraphs

# Don't indent new paragraphs
#+latex_header: \setlength\parindent{0pt} 

# Don't hyponate words, instead break line
#+latex_header: \tolerance=9999
#+latex_header: \emergencystretch=10pt
#+latex_header: \hyphenpenalty=10000
#+latex_header: \exhyphenpenalty=100

* R & Emacs Lisp                                            :noexport:ignore:

#+name: setwd
#+begin_src R :results output :session :exports results
# set directory to top of git repo (assume paper_poster_plots in threemc-orderly)
# dir <- dirname(system("git rev-parse --show-toplevel", intern = TRUE))
dir <- "~/imperial_repos/threemc-orderly/"
setwd(dir)
#+end_src

#+RESULTS: setwd
: [1] "/home/paddy7wb/imperial_repos/threemc-orderly"

** Emacs Lisp Functions

Function to remove
#+begin_src emacs-lisp
(defun delete-org-comments (backend)
  (loop for comment in (reverse (org-element-map (org-element-parse-buffer)
                    'comment 'identity))
    do
    (setf (buffer-substring (org-element-property :begin comment)
                (org-element-property :end comment))
          "")))

(let ((org-export-before-processing-hook '(delete-org-comments)))
  (switch-to-buffer (org-latex-export-as-latex)))
#+end_src


* Authors & Affiliations                                        :ignore:

# Authors
#+latex_header: \author[1]{Patrick O'Toole}
#+latex_header: \author[1,2]{Matthew L. Thomas}
#+latex_header: \author[1]{Oliver Stevens}
#+latex_header: \author[1,3]{Kevin Lam}
#+latex_header: \author[4]{Katherine Kripke}
#+latex_header: \author[1]{Rachel Esra}
#+latex_header: \author[5]{Ian Wanyeki}
#+latex_header: \author[5]{Lycias Zembe}
#+latex_header: \author[1]{Jeffrey W. Eaton}

# Affiliations
#+latex_header: \affil[1]{\emph{Imperial College London, London, United Kingdom}} \\
#+latex_header: \affil[2]{\emph{Joint Centre for Excellence in Environmental Intelligence, University of Exeter and Met Office}} \\
#+latex_header: \affil[3]{\emph{Department of Statistics, University of British Columbia}} \\
#+latex_header: \affil[4]{\emph{Avenir Health, Takoma Park, MD, USA}} \\
#+latex_header: \affil[5]{\emph{Joint United Nations Programme on HIV/AIDS (UNAIDS)}} \\

# Break page
#+latex: \clearpage

* Methods 

** Plan                                                            :noexport:

See [[file:outline/paper_outline.org][paper outline]]

For data:
:fig_1_caption:
Figure 1: Household surveys detailing circumcision patterns in SSA. The colour and size of points
are determined by the provider and sample size of each respective survey. Triangular points have
no information on circumcision type.
:END:

Also for data, could add stuff on:
- Missing data (& inability to model in some countries) (see Kinh's paper)
- Mention irregularity with some PHIA surveys?
- Missing countries, countries with no type, countries with no age info

** Text                                                              :ignore:

*** Data (pre Matt)                                                :noexport:

**** Surveys                                                         :ignore:

#+name: survey_inlines
#+begin_src R :results output :session :exports results
data_inlines <- readRDS("paper_poster_plots/paper/data/01_data_inlines.RDS")
#+end_src

#+RESULTS: survey_inlines

Several major survey series included questions on male circumcision status, namely the Demographic and Health Surveys (DHS), AIDS Indicator Surveys (AIS) Population-based HIV Impact Assessment (PHIA) surveys, Multiple Indicator Cluster Surveys (MICS), and, in the case of South Africa, Human Sciences Research Council (HSRC) surveys.

These surveys provided individual-level data on self-reported circumcision status by male respondents, and from this we estimated circumcision rates over time and by type for the years proceeding each survey. The following questions were of interest:
- The circumcision status of the male individual,
- The circumcision provider: whether the individual was circumcised by a health worker/professional, traditional practioner, other or unknown,
- The circumcision location: whether the individual was circumcised at a health facility, in the home of a health worker/professional, at home, at a ritual site, other or unknown
- The circumcision year, and
- The date of birth and age at response and circumcision.

The age of respondents was calculated from the century-month-code (CMC) of birth and interview dates.
PHIA surveys did not include a question for circumcision location. Circumcisions performed by a medical professional and/or in a medical setting are categorised as MMC. Otherwise, circumcisions are TMC. Where no data is present on location or provider, circumcision type is treated as "Missing". 
#+begin_comment
Should I include something about how (some?) PHIA surveys censor over 35 circumcisions?
#+end_comment
Respondents were located to their districts using masked cluster geocoordinates. Where these coordinates were unavailable, as in several MICS surveys, respondents were located to their admin level 1 area hierarchy, most often corresponding to a province. 

#+begin_comment
Should I include something about how (some?) PHIA surveys censor over 35 circumcisions?
#+end_comment

**** Populations                                                     :ignore:

# - Sub-national populations from WorldPop (reference) were used to infer circumcision coverage from rate estimates. 
Sub-national populations from WorldPop were used to calculate circumcision coverage from circumcision rates. (reference)

**** Old                                                           :noexport:
***** Surveys (old)                                         :noexport:ignore:

#+name: survey_inlines
#+begin_src R :results output :session :exports results
data_inlines <- readRDS("paper_poster_plots/paper/data/01_data_inlines.RDS")
#+end_src

#+RESULTS: survey_inlines

Our data consisted of src_R[:exports results :session :results raw]{data_inlines$n_surveys}  
nationally representative household surveys conducted in
src_R[:exports results :session :results raw]{data_inlines$n_iso3} SSA countries
between src_R[:exports results :session :results raw]{data_inlines$min_year} and src_R[:exports results :session :results raw]{data_inlines$max_year}.
These included several major survey series, namely the Demographic and Health Surveys
(DHS), AIDS Indicator Surveys (AIS) Population-based HIV Impact Assessment (PHIA) surveys,
Multiple Indicator Cluster Surveys (MICS), and, in the case of South Africa,
Human Sciences Research Council (HSRC) surveys.
Any surveys including a question on MC status were included. 
Unfortunately, no information on age at circumcision was present in the 2004 and 2008 Botswana
Aids Impact Surveys. This complete left censoring of circumcised individuals meant that we were
unable to fit our model there. 

#+begin_comment
Should I include something about how a new DHS is expected for BWA soon?
#+end_comment

These surveys provided individual-level data on self-reported circumcision status by male
respondents, and from this we estimated circumcision rates over time and by type for the years proceeding each survey. The following questions were of interest:
- The circumcision status of the male individual,
- The circumcision provider: whether the individual was circumcised by a health worker/professional, traditional practioner, other or unknown,
- The circumcision location: whether the individual was circumcised at a health facility, in the home of a health worker/professional, at home, at a ritual site, other or unknown
- The circumcision year, and
- The age at circumcision.

PHIA surveys do not include a question for circumcision location. Circumcisions performed by a medical professional and/or in a medical setting are categorised as MMC. Otherwise, circumcisions are TMC. Where no data is present on location or provider, circumcision type is treated as "Missing". Refer to section x of the appendix to see specific questions asked in each survey.

#+begin_comment
Should I include something about how (some?) PHIA surveys censor over 35 circumcisions?
#+end_comment

Respondents were located to their districts using masked cluster geocoordinates. Where these
coordinates were unavailable, as in several MICS surveys, respondents were located to their admin
level 1 area hierarchy, most often corresponding to a province. 

Participation rates for each survey can be found in section x of the appendix. 

#+CAPTION: Household surveys detailing circumcision patterns in SSA. The colour and size of points are determined by the provider and sample size of each respective survey. Triangular points have no information on circumcision type.
#+NAME: fig1
#+begin_src R :exports results :results file graphics :file plots/01_survey_table.pdf :width 9 :height 10
# source("paper_poster_plots/scripts/03_results_data.R")
# p1 <- readRDS("paper_poster_plots/paper/plots/01_survey_table.RDS")
p1 <- readRDS("./plots/01_survey_table.RDS")
print(p1)
#+end_src

/Figure 1: Household surveys detailing circumcision patterns in SSA. The colour and size of points are determined by the provider and sample size of each respective survey. Triangular points have no information on circumcision type./

***** Older still

120 household surveys conducted in 33 SSA countries 2002-2019
Self-reported circumcision:
- Status (MC vs uncircumcised), 
- Type (MMC vs TMC), 
- Year, and
- Age 
recorded
Sub-national populations from WorldPop (reference)

Major survey series (DHS, AIS, PHIA, MICS, HSRC in ZAF)
Individual-level data: self-reported circumcision status  by male respondents
Respondents located to districts using cluster geocoordinates
Located to admin 1 (province) where coordinates not available (MICS)
VMMC programme data not used

Circumcisions performed by a medical professional and/or in a medical setting are categorised as MMC
Otherwise, circumcisions are TMC
Where no data is present on location or provider, circumcision type == Missing

Individual-level household survey data provide direct estimates of circumcision rates over time and by type for years preceding survey

- Direct estimates of TMC practices, age at circumcision, VMMC impact
Include participation rates from surveys in paper!


#+latex: \newpage

*** Data 
**** Survey Data

The study consisted of 33 sub-Saharan countries, which in approximate order from North to South and then West to East are: Senegal, Gambia, Guinea, Sierra Leone, Liberia, Mali, Burkina Faso, Côte d’Ivoire, Ghana, Togo, Benin, Niger, Nigeria, Cameroon, Chad, Ethiopia, Gabon, The Republic of the Congo (the Congo), The Demorcratic Republic of the Congo (DR Congo), Uganda, Kenya, Rwanda, Burundi, Tanzania, Angola, Zambia, Malawi, Mozambique, Zimbabwe, Namibia, Eswatini, Lesotho, South Africa". 
We excluded 4 countries: Equitorial Guinea, Guinea-Bissau, the Central African Republic and Botswana. These were excluded because they either had no surveys conducted, or, where surveys were available, there was insufficient information available on circumcision.  

We identified 109 nationally representative household surveys conducted the study region  between 2002 and 2019. 
These included several major survey series, namely the Demographic and Health Surveys (DHS), AIDS Indicator Surveys (AIS) Population-based HIV Impact Assessment (PHIA) surveys, Multiple Indicator Cluster Surveys (MICS), and, in the case of South Africa, Human Sciences Research Council (HSRC) surveys *[Citations]*. 
Data on self-reported circumcision status were available in 104 out of the total 109 surveys. 
*[Expand on reasons for exclusions]* [Link in your survey figure] Excluded surveys lacked information on age at circumcision, which made it impossible to make inferences on circumcision under our time-to-event modelling framework.  

 #+NAME: fig1
 #+begin_src R :exports results :results file graphics :file plots/01_survey_table.pdf :width 9 :height 10
 # source("paper_poster_plots/scripts/03_results_data.R")
 # p1 <- readRDS("paper_poster_plots/paper/plots/01_survey_table.RDS")
p1 <- readRDS("./plots/01_survey_table.RDS")
print(p1)
 #+end_src

 #+RESULTS: fig1
 [[file:plots/01_survey_table.pdf]]

/Figure 1: Household surveys detailing circumcision patterns in SSA. The colour and size of points are determined by the provider and sample size of each respective survey. Triangular points have no information on circumcision type./


Demographic variables such as age, residence and survey sampling weight were extracted from all surveys, alongside information related to circumcision: self-reported circumcision status, age at circumcision, Who performed the circumcision (whether the individual was circumcised by a health worker/professional, traditional practioner, other or unknown)  and Where did the circumcision take place (whether the individual was circumcised at a health facility, in the home of a health worker/professional, at home, at a ritual site, other or unknown). *[Write and link in survey table].*

#+begin_src latex
\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}

\begin{longtable}{l|llll}
\toprule
\multicolumn{1}{l}{} &  &  & \multicolumn{2}{c}{Circumcision Type} \\ 
\cmidrule(lr){4-5}
% \multicolumn{1}{l}{} & Self-reported circumcision status & Age at circumcision & Who performed the circumcision? & Where did the circumcision take place? \\ 
\multicolumn{1}{l}{} & \begin{tabular}{c}Self-reported \\[-5pt] circumcision status\end{tabular} & Age at circumcision & \begin{tabular}{c}Who performed \\[-5pt] the circumcision?\end{tabular} & \begin{tabular}{c}Where did \\[-5pt] the circumcision take place?\end{tabular} \\ 
% \begin{tabular}{c}Healthcare\\[-5pt] Professional\end{tabular}
\midrule
AGO 2015 DHS & \cmark & \cmark & \cmark & \cmark \\ 
BDI 2010 DHS & \cmark & \cmark & \cmark & \cmark \\ 
BDI 2016 DHS & \cmark & \cmark & \cmark & \cmark \\ 
\bottomrule
\end{longtable}
#+end_src

#+RESULTS:
#+begin_export latex
\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}

\begin{longtable}{l|llll}
\toprule
\multicolumn{1}{l}{} &  &  & \multicolumn{2}{c}{Circumcision Type} \\ 
\cmidrule(lr){4-5}
% \multicolumn{1}{l}{} & Self-reported circumcision status & Age at circumcision & Who performed the circumcision? & Where did the circumcision take place? \\ 
\multicolumn{1}{l}{} & \begin{tabular}{c}Self-reported \\[-5pt] circumcision status\end{tabular} & Age at circumcision & \begin{tabular}{c}Who performed \\[-5pt] the circumcision?\end{tabular} & \begin{tabular}{c}Where did \\[-5pt] the circumcision take place?\end{tabular} \\ 
% \begin{tabular}{c}Healthcare\\[-5pt] Professional\end{tabular}
\midrule
AGO 2015 DHS & \cmark & \cmark & \cmark & \cmark \\ 
BDI 2010 DHS & \cmark & \cmark & \cmark & \cmark \\ 
BDI 2016 DHS & \cmark & \cmark & \cmark & \cmark \\ 
\bottomrule
\end{longtable}
#+end_export

The age of respondents was calculated from the century-month-code (CMC) of birth and interview dates. 
Survey respondents were located to their districts using masked cluster geocoordinates. 
Where these coordinates were unavailable (as in several MICS surveys) respondents were located to their level 1 administrative boundaries, most often corresponding to a province.  

Circumcisions were classed as a medical male circumcision (MMC) and traditional male circumcision (TMC) sing responses to both ‘Who performed the circumcision?’ and ‘Where did the circumcision take place?’ were classified *[Link to the table]*. 
Respondents that did not have any information related to the type of circumcision were classified as having an “unknown” male circumcision (MC).   
#+begin_src latex
\begin{table}[htbp]
	\centering
	\caption{Criteria used to classify circumcisions from the survey data as MMC or TMC.}
	\label{tab::MCclassification}
	\begin{tabular}{c l | c c c}
	\multirow{2}{*}{} & & \multicolumn{3}{c}{Who performed the circumcision?} \\
	                    &      & \begin{tabular}{c}Healthcare\\[-5pt] Professional\end{tabular} & \begin{tabular}{c}Traditional \\[-5pt] Practioner\end{tabular} & \begin{tabular}{c}Missing\end{tabular} \\
	                          \hline
		% \multirow{3}{*}{\rotatebox{90}{Where performed?}}  & \begin{tabular}{l}Healthcare Facility\end{tabular} & MMC & MMC & MMC \\
		\multirow{3}{*}{\rotatebox{90}{\begin{tabular}{c}Where\\[-5pt] Performed?\end{tabular}}}  & \begin{tabular}{l}Healthcare Facility\end{tabular} & MMC & MMC & MMC \\
		& \begin{tabular}{l}Home/Ritual Site\end{tabular} & MMC & TMC & TMC \\
		& \begin{tabular}{l}Missing\end{tabular} & MMC & TMC & Missing \\
	\end{tabular}	
\end{table}
\\
#+end_src

In total, information was extracted from XXX, XXX respondents from all surveys.
*[Participation rates table]*

**** Administrative boundaries 

[Add in information about the boundaries] 

**** Population 

Estimates for the male population size by district and five-year age group from 2002 through 2019 were sourced from XXX. 
Distributed (?) to single-year of age according to ??? 

*** Model (pre Matt)                                               :noexport:

"threemc" (Matt's model for male circumcision) (or "Multi-level model for male circumcision"?) is
a Bayesian, spatio-temporal, competing-risks, time-to-event model (reference). We have extended
this model from its initial application in South Africa to
src_R[:exports results :session :results raw]{data_inlines$n_iso3}
countries within the SSA region. The model produces estimates of circumcision rates, incidence and coverage (i.e. cumulative indidence), with associated uncertainty bounds, stratified by type, year, age and location. Circumcision rates are projected after their most recent household survey
assuming continuation of estimated age-specific rates, with probabilistic uncertainty. Estimates
for single ages were binned into 5-year age groups from 0-4 to 54-59, and other age groups of interest, such as the VMMC target age group of 10-29 year-olds.

A key assumption of the original threemc model was that TMC was constant over time, due to the perceived intransigence in TMC practises and traditional male initiation ceremonies amongst tribal, cultural and religious groups which have developed over time. MMCs amongst paediatric males, defined as those under 10, were also assumed to be constant over time, as VMMC programmes, the  main force behind the adoption of MMC in much of SSA, do not targets males below 10 (reference).

Countries were modelled at the organizational level in which the country team has prioritised their program, called the PSNU area level, or the most granular level available in surveys. Model estimates were weighted by population and post-stratified to produce estimates for their "parent" regions. 

Some additional features were added to threemc during the course of this analysis: 
- Where no information on circumcision type was available for every survey in a given country, a type-agnostic version of the model was used,
- Survey estimates for less granular areas were used to inform likelihood estimation for their "child" areas, where previously they were ignored,
- optional addition of a temporal effect for TMC, due to the suggestion of survey estimates that TMC practices may be changing, even in non-VMMC target countries, over time, and
- an optional random walk (RW) temporal prior was implemented, where previously only an auto-regressive (AR1) temporal prior was available.

**** Old                                                           :noexport:
Bayesian spatio-temporal, competing-risks, time-to-event model
Stratified by age, location and time
Rates of TMC and medical male circumcision (MMC) estimated
Coverage in 2020 projected assuming continuation of estimated age-specific rates with probabilistic uncertainty
Important assumption: Probability of traditional male initiation ceremonies (TMICs) constant over time (needed? Might lead to a lot of questions!) 

Model stratified by:
Age
District
circumcision type (traditional / medical)

TMC & MMC rates estimated (by age, district, and time)
Spatial smoothing allows for district level estimates

Circumcision coverage since most recent HH survey: projected assuming continuation of estimated age-specific rates, with probabilistic uncertainty

Important assumption: TMC rate assumed constant over time


#+latex: \newpage



*** Model 

/Put a general discussion element for the model giving an overview/

"threemc"("Multi-level model for male circumcision") is a Bayesian, spatio-temporal, competing-risks, time-to-event model (reference). 
We have extended this model from its initial application in South Africa to 33 countries within the SSA region. 
The model produces estimates of circumcision rates, incidence and coverage (i.e. cumulative indidence), with associated uncertainty bounds, stratified by type, year, age and location.
Circumcision rates are projected after their most recent household survey assuming continuation of estimated age-specific rates, with probabilistic uncertainty. 
Estimates for single ages were binned into 5-year age groups from 0-4 to 54-59, and other age groups of interest, such as the VMMC target age group of 10-29 year-olds.  

/Traditional Circumcision/

A key assumption of the original threemc model was that TMC was constant over time, due to the perceived intransigence in TMC practices and traditional male initiation ceremonies amongst tribal, cultural and religious groups which have developed over time. 
MMCs amongst paediatric males, defined as those under 10, were also assumed to be constant over time, as VMMC programmes, the main force behind the adoption of MMC in much of SSA, do not targets males below 10 (reference). 

[Technical details] 

Explain the TMC with time and TMC with no time.  

/Medical Circumcision/

Explain paed cut off and no paed cut off 

*** Model Specification

**** Notes                                                         :noexport:
Jeff:
- Model selection: particularly interested in  
- (1) Model specification for time trends in TMC and paediatric circumcision -> in sample fit 
- (2) Short-term future projections; ensuring appropriate future uncertainty in all countries
   -> out-of-sample prediction withholding the final survey (and any survey in the one year previous) 

- Choose best model specification (i.e. which terms to include (TMC, paediatric MMC, etc)) for
  each country using within-sample validation.
- Include figures comparing models for each country in appendix, refer to them here.
#+begin_comment
Here describe the method used for the comparison (out of sample prediction process) and
metrics used for comparison. Report the results of the model selection in the appendix.
#+end_comment
- Credible interval coverage, ELPD, CRPS and fit statistics (ME, MSE, RMSE) used to inform
  decision. 

**** Rough draft (w/out figures & conclusions) (May go to appendix)  :ignore:

In our choice of model specification, we were interested in two main assumptions/features of the
model:
- How we should treat TMC, in terms of whether to continue to assume a constant rate of TMC over time, or to reject that assumption,
- How to model paediatric MMC, which should be minimal in at least the VMMC target countries.

If possible, we hoped to use the same model for every country, or failing that, come up with a
satisfactory choice of model specification which would make sense both qualitatively and
quantitatively. 

***** Qualitative                                         :ignore:
\\
Qualitatively, we have made some presumptions about certain countries and their circumcision patterns.
In non-VMMC SSA countries, concentrated in Western and Central Africa (WCA), TMC has historically made up the bulk of MCs.
Therefore, most MMCs in non-VMMC countries are likely to have superseded TMCs performed as part of traditional male initiation ceremonies. This suggests that MMCs in these countries are likely to be on paediatric individuals in traditional settings, so the assumption of constant and
negligible paedaitric MMC could be a poor one. 
Because any increases in MMC will come at the expense of TMC in our "competing-risks" model, it is also plausible that the assumption that TMC rates in these countries have been relatively constant may be unrealistic.
It is therefore likely that the inclusion of a time effect for TMC and not partitioning MMC into adult and time-invariant paediatric rates will be a more realistic reflection of circumcision
patterns in non-VMMC countries.  

# Since changes to MMC in non-VMMC programmes will not have been as a result of VMMC programmes, it is likely that circumcision patterns have undergone a generational change as a result of general development in their countries. As such, a time effect for TMC in non-VMMC countries is very important for accurately modelling and understanding their circumcision patterns, particularly in how the relative makeup of M

# (Note: would be a good idea to look into surveys for these countries to see if this checks out! I.e. for non-VMMC and VMMC surveys, it might be a good idea to compare the number of people with different circumcision types for location and provider,  to substantiate this assumption)

Conversely, in VMMC priority countries changes in circumcision patterns have largely been driven by the intervention of VMMC programme implementation. 
As such, it is more realistic to assume that paediatric MMCs are minimal, in line with UNAIDS VMMC policy.
It is more difficult to say whether the rate of TMC will be constant over time in non-VMMC countries.
Historical TMC patterns in these countries, differ significantly, even subnationally.
It may therefore be more realistic to also allow TMC to vary over time in VMMC countries.
In countries where the rate of TMC is stable over time, the model will capture this behaviour, while in countries where TMC varies over time, the inclusion of a time effect for TMC will provide the model with the additional required flexibility to identify this trend.
We would also prefer to not have to treat every VMMC priority country separately with regards to their model specification, so including a time effect for TMC in the models for these countries seems like a logical choice. 

***** Quantitative                                                   :ignore:
\\
We have also performed a quantitative analysis of the different model specifications available
to us. A more detailed treatment of this can be found in section x of the appendix. 

#+begin_comment
- Explain method, why within-sample comparison performed here
- Describe posterior predictive comparison between model fit and empirical survey coverage estimates
- For "For x / y SSA countries" the model with .. parameters had better model fit (quote some stats)
- "For x / y non-VMMC countries, the model with ...
- "For x / y VMMC countries, the model with ...
- Therefore, our quantitative analysis reinforces what we expected to be the best model specifications for VMMC and non-VMMC countries from our quantitative arguments. 
*TODO: Add that we didn't do this for countries with no type information!*
#+end_comment

For each country, we fit a model for each possible model specification for threemc, that is:
- for each choice of temporal prior, namely AR1, RW1 and RW2,
- a choice of whether or not to include a paediatric age cutoff for MMC of ten, and
- a choice of whether to include a temporal effect for TMC. 
Thus totalling 12 possible models for each country.
These models were fit to all of the survey data available, rather than a subset of the data.
This was because we were most interested here in seeing how the inclusion of a peadiatric age cutoff and/or a temporal TMC effect would effect the fit of the model to the data available, rather than in the relative short-term forecasting ability of the different specifications.
As the choice of temporal prior was more important when forecasting, we were not especially interested in how each of these performed here, but regardless we fit for each temporal prior, for completeness. 

The survey weighted empirical survey circumcision coverage was compared to a sample of 1000 draws from the posterior predictions of circumcision coverage for each country.
Both were aggregated to area level 1 and to five year age groups (from 15-19 through 55-59), to avoid having too many zeros in the survey estimates.
# Multiple comparisons between the two were made, including the expected log-predictive density (ELPD), the continous ranked probability score (CRPS), the mean error (ME), mean squared error (MSE) and root mean squared error (RMSE).
# We also looked at the credible interval coverage.
# To calculate this, we took a binomial sample, from the posterior predictive distribution of circumcision coverage.
# We then find the percentage of our weighted survey coverage estimates which fall into the 2.5$^{th}$, 10$^{th}$, 25$^{th}$, 50$^{th}$, 75$^{th}$, 90$^{th}$ and 97.5$^{th}$ percentiles, (TODO:Continue here! Think this is wrong too lol, run task in R to understand how this all works, also look at previous notes)
Comparisons were made of mean predictions, using expected log-posterior density (ELPD) and continuous ranked probability scores (CRPS), as well as error statistics such as the mean error (ME), root mean error (RME) and root mean error squared (RMSE).
Also evaluated was the the "calibration" of our model with regards to it's posterior predictive uncertainty.
This involved comparing survey estimates of circumcision coverage with the 50%, 80% and 95% credible intervals (CIs) of our posterior predictive distribution. A "good" calibration was regarded as one in which roughly 50% of survey observations fell within the 50% CI range, 85% within the 85% CI range, and 95% within the 95% range.
Seeing as we were comparing within-sample mean estimates, we were particularly interested in the RMSE of our predictions compared to the survey estimates. 

Just as we distinguished between VMMC and non-VMMC countries when considering the qualitative merits of each model specification, so too did a pattern emerge here when quantitively comparing the model fits for both sets of SSA countries. 

For the non-VMMC countries there was a drastic difference in mean predictive accuracy between the different model specifications.
The best model specification was the model which included a temporal TMC effect, but not a paediatric age cutoff for MMC.
This specification performed the best for x / y countries, averaging a RMSE of x, CRPS of x and ELPD of x, in comparison to the next best specification, ?, which averaged an RMSE of x, CRPS of x and ELPD of x. 
It appeared that the inclusion of a temporal TMC effect was very influential in improving the fit of the model for non-VMMC countries, with specifications including this term averaging a RMSE of x versus x for those which did not include this term.
Models including an MMC paediatric age cutoff of 10 consistently performed worse than other models, averaging an RMSE of x versus x. 
These findings were in line with our previous intuitions on MC patterns in non-VMMC, mainly WCA countries, where TMC was historically high, and increases in MMC are likely within the previously TMC population, and hence MMCs were likely performed on younger individuals than in VMMC countries. 

In contrast, for the VMMC priority countries, the choice of whether to include an MMC paedaitric age cutoff had little effect on model fit.
This may be because under fifteens were not surveyed, and so there were no survey estimates for paediatric populations to compare to our model predictions.
However, the inclusion of this MMC paediatic age cutoff did have a negative effect to the fit for the models to adults for non-VMMC countries, so the fact that it's inclusion here did not hurt model fit suggests it was a more accurate representation of MMC patterns in VMMC priority countries.
As we were aware of VMMC programme policy in not currently circumcising under fifteens, and since it did not seem to negatively effect model fit to adults, we decided to include a paediatric age cutoff of 10 in the model for VMMC coutries. 
# Kenya, however, stood out here as a country with high TMC, as it's patterns of circumcision, and the best model specification for the country, appeared to more closely match that of the non-VMMC countries with historically high TMC, rather than the other VMMC priority countries. 
Models which including a temporal TMC effect were marginally better, with an average RMSE of x versus x for all other models.
In particular, Kenya, which had high historical TMC in most regions and was the most similar of the VMMC countries to WCA countries in terms of it's circumcision patterns, saw a marked improvement when this effect was included, with an average RMSE of x versus x. For completeness, we decided to include a temporal effect for TMC in the model specification for VMMC priority countries.
#+begin_comment
Note: We have a paedaitric age cutoff of 10, but we know (do we?) that VMMC programmes do not circumcise under 15s, so why didn't we use a cutoff of 15? 
Note: Need to include something on posterior predictive coverage as well here, basically just saying how it didn't significantly change for different models, largely because uncertainty was relatively low for within-sample predictions. 
#+end_comment

It was therefore ultimately decided to include a temporal effect for TMC in the model for both VMMC and non-VMMC countries, while only including a pedaitric age cutoff for VMMC countries.
A table with the full set of fit statistics for each model specification for each country can be found in section x of the appendix.

*** Model Calibration and Choice of Temporal Prior

**** Notes                                                         :noexport:
- Calibrated MMC-related variance hyperparameters using grid search. Idea is to use information
  from countries with more surveys to inform variance (which was suspected to be underestimated)
  in countries with fewer surveys, analagous to using a model with partial pooling for each
  country in the Sub-Saharan region, which would be much too computationally expensive to fit. 

**** Another very rough draft  (not sure if everything here is appropriate for this section) (much of this will probably go to the appendix as well!) :ignore:

#+begin_comment
- Reason why we need to calibrate models (lack of recent surveys), would like more dramatic
fanning out of uncertainty to reflect this (done)
- Two main drivers of uncertainty: i) sigma hyperparameters, and ii) temporal prior selection (done)
- Due to computational constriants, cannot fit partially pooled model (done)
- Instead, use common time-related hyperparameters across all models (done)
- To find optimal hyerparameters, performed grid search over sensible values from "naive" fits (done)
- Results, possibly split between VMMC and non-VMMC countries
- Conclusions
#+end_comment

For some VMMC priority countries, we did not have access to more recent survey data. 
One particular country where this is the case is Tanzania, whose most recent survey was the 2016 PHIA survey.
In these circumstances, there may have been a significant increase in MMC coverage due to VMMC programme implementation which was not captured within our survey period.
VMMC programme data was an available source of more recent circumcision data.
The DMPPT2 model explicitly used this data to estimate MMC. 
The results of DMPPT2, as well as those for countries with more recent surveys who have experienced significant MMC scaleups, suggest that VMMC may have scaled up at a rate not anticipated by threemc where only these older surveys are available.
This was consistent with out-of-sample (OOS) exploration of model fits to countries like Zimbabwe, where removing access to the most recent (2018 DHS) survey similarly underestimates VMMC scale up.
Hence, it was felt that threemc likely underestimates uncertainty with regards to predicting circumcision coverage for progressively later years from our last available surveys, particularly in the case of VMMC priority countries, which have seen rapid increases in historically low circumcision.
A more dramatic "fanning" out of our prediction interval as we forecast further from the last available survey data was therefore deemed desirable, consistent with having greater uncertainty in our future forecasts. 

#+begin_comment
should I include a plot here of ZWE results for out-of-sample evaluation, with DMPPT2 and survey results also in it? 
#+end_comment

The two main drivers of uncertainty over time in threemc were:
- The variance hyperparameters relating to time, including the variance hyperparameters for space-time and age-time interactions, and 
- The choice of temporal prior, for which threemc supports the use of an AR1, RW1 or RW2 prior. 
The "unpooled" optimised time-related variance hyperparameters for the model fit for each respective country varied significantly, but in general certain patterns and values for these hyperparameters could be associated with a having larger bounds for successive prediction years.
  
Due to computational constraints, we could not model the entire SSA region together as one singular area hierarchy, which, through partial pooling and the neighbourhood correlation structure inherent in the model, would allow the model to borrow information from countries with a large amount of available data to inform predictions in countries with older and/or fewer surveys.
One alternative to using a partially-pooled model was to use the uncertainty estimates which produce the best predictions for countries with more recent data to inform our uncertainty estimates in countries with less recent survey data available.
To quantitatively explore this hypothesis, we performed an OOS evaluation of the model fit to each country, removing their most recent survey data (or, in the case where there were two surveys in subsequent years, the two most recent surveys) and comparing posterior predictions to the survey-estimated circumcision coverage, as we did with our analysis of different model specifications.
A grid search over sensible variance hyperparameter values from the "naive" threemc fits for each country and temporal prior was employed, to determine the optimal values and temporal prior choice. 
For the AR 1 model, the effect of different time correlation parameters on our uncertainty bounds was determined to be minimal, and in the interests of parsimony, these parameters were ignored in our calibration efforts with this model.

TODO: Finish this write up!
TODO: Add results! Also add ternary plot 

* References                                                         :noexport:

#+PRINT_BIBLIOGRAPHY

* Appendix                                                         :noexport:
* Additional                                                       :noexport:
** Acronyms

Male Circumcision - MC

** TODOS                                                           :noexport:

*** Important Initial Setup
**** DONE Setup autocompilation with latex (code actually makes a lot of sense!)
CLOSED: [2022-10-19 Wed 15:10]
https://www.reddit.com/r/orgmode/comments/n74ehs/orgmode_export_to_pdf_with_capability_to_preview/
https://github.com/munen/emacs.d#convenience-functions-when-working-with-pdf-exports

***** DONE Set up `pdf-tools`
CLOSED: [2022-10-19 Wed 13:00]
https://github.com/vedang/pdf-tools
**** TODO Set up bibtex citations (using org-cite?)
https://kristofferbalintona.me/posts/202206141852/
***** TODO Setup Zotero


**** TODO Copy relevant poster script and text to paper
**** TODO Copy relevant presentation text to paper
*** Scripting
**** TODO Write script which saves plots
**** TODO Write R code to include here for inline figures, etc
**** TODO Write Makefile to pull paper together

Makefile will need to:
- Run script to save plots
...
- Use pandoc (or pdflatex?) to convert org to (tex and then) pdf, having pulled everything else in


*** Formatting
**** DONE Remove table of contents
   CLOSED: [2022-10-17 Mon 11:53]
**** DONE Don't indent new paragraphs
CLOSED: [2022-10-19 Wed 15:46]
**** DONE Format abstract (see abstract todos section)
CLOSED: [2022-10-19 Wed 16:13]
***
**** DONE Break lines rather than having hyponated words on two lines
CLOSED: [2022-10-20 Thu 09:42]
**** DONE Make margins smaller (see Matt's latex code)
CLOSED: [2022-10-20 Thu 09:51]
**** DONE Insert whitespace between new paragraphs
CLOSED: [2022-10-20 Thu 09:51]
*** Title Page 
**** TODO Think of better title (Ask Jeff about this)
May be fine? But not very different to other examples
**** TODO Add full affiliated institution name to (formatted) authors
***  Abstract 
**** DONE Format abstract correctly
   CLOSED: [2022-10-17 Mon 13:54]

   Had to use pure latex to achieve this, but looks good now

**** TODO Rewrite abstract (slightly rewritten in poster script, need to rewrite arís)
***** TODO Add about comparison to survey and DMPPT2 estimates

***** TODO Add about (i) hyperpar/prior investigation and (ii) treatment of TMC and paediatric MMC
Can call this "model calibration" and specification

For (i), something like:
The model was calibrated ... pooled MMC variance covariance hyperparameters ... using forecast
for withheld survey. 

    
***** TODO Add something about different ages

**** TODO Write script to pull in variables for abstract figures
*** Background
*** Data 
**** TODO Rewrite to pull in survey info with inline code


**** TODO Insert plots
***** TODO Survey series plots
***** TODO Circumcision type plots
*** Methods
*** Results
*** Discussion
*** References
** Links                                                           :noexport:
*** Papers 

TODO: Reference these!

- [[https://onlinelibrary.wiley.com/doi/10.1002/jia2.25788][Naomi]]
- [[https://apps.who.int/iris/bitstream/handle/10665/246234/WHO-%AD%20HIV-%AD%202016.17-%AD%20eng.pdf?sequence=1][UNAIDS Framework for VMMC]]
- https://spiral.imperial.ac.uk/bitstream/10044/1/75693/6/application-pdf%20%281%29.pdf (EPP-ASM paper, has lots on calibrating models)
References for DHS, AIS & PHIA here https://www.medrxiv.org/content/10.1101/2022.07.12.22277551v1.full.pdf   
[[https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0020298][Randomized, Controlled Intervention Trial of Male Circumcision for Reduction of HIV Infection Risk]]
[[https://www.thelancet.com/journals/langlo/article/PIIS2214-109X(19)30038-5/fulltext][Benefits of Circumcision for MSM]] 
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4539243/ (another paper on circs referenced here)

Cork paper https://ora.ox.ac.uk/objects/uuid:677ccf82-44b7-4495-b304-b2a0c9db9e3b

[[https://www.nature.com/articles/nrdp201535][HIV Infection, Nature]]
[[https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(18)31311-4/fulltext][HIV, The Lancet]]


**** Paper Examples

- DMPPT2 Paper https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0156909
- Matt's paper https://arxiv.org/pdf/2108.09142.pdf (ask for diagram of data sources)
- Naomi paper https://spiral.imperial.ac.uk/bitstream/10044/1/90881/12/jia2.25788.pdf
- Paper by Kinh and Jeff which also covers SSA https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-022-13451-y#availability-of-data-and-materials

**** Circumcision Papers, for introduction etc**
***** [[https://arxiv.org/pdf/2108.09142.pdf][Matt's Paper]]
***** [[https://onlinelibrary.wiley.com/doi/10.1002/jia2.25789][Estimating male circumcision coverage in 15 priority countries in sub-Saharan Africa]]
***** [[https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0156909][DMPPT2, Kripke K]]
***** [[https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0020298][Randomized, Controlled Intervention Trial of Male Circumcision for Reduction of HIV Infection Risk]] (more included in Matt's paper)
***** [[https://www.thelancet.com/journals/langlo/article/PIIS2214-109X(19)30038-5/fulltext][Benefits of Circumcision for MSM]]
***** [[https://www.researchgate.net/publication/354752731_Estimating_male_circumcision_coverage_in_15_priority_countries_in_sub-Saharan_Africa/fulltext/614b20f1a3df59440ba1a359/Estimating-male-circumcision-coverage-in-15-priority-countries-in-sub-Saharan-Africa.pdf?origin=publication_detail][DMPPT2 paper]] (applied here)
***** Lit Review on VMMC 
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4777442/
**** Plosmed papers, for formatting
***** https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1001245
- This paper's background includes a background, methods and findings, and conclusions sections, and is written by Jeff, so I should
have something similar!


*** Org-mode Paper Links

- Latex template for ArXiv (may be useful) https://www.overleaf.com/latex/templates/arxiv-slash-biorxiv-template/phncddwqtxpc

- Thesis done in Org-mode
https://github.com/aidanscannell/phd-thesis/edit/master/phd-thesis.org

** Notes                                                           :noexport:  
*** Plan, Questions, etc

Need to include sections on: 
- Comparison of models with different treatments of TMC and paediatric MMC
- Comparison of temporal priors and MMC variance/covariance hyperparameters
- Comparison to DMPPT2 data
- Comparison to survey data 
(not necessarily in this order!)

Will these be included in all of methods, results, discussion? 

** Settings                                                        :noexport:

***  macros                                                        :noexport:
**** Old 
#+name: auth_and_affil
#+begin_src latex :tangle auth_and_affil.sty :session
  \newcommand{\somemacro_1}{

    \usepackage{authblk}

    % authors
    \author[1]{Patrick O'Toole}
    \author[1,2]{Matthew L. Thomas}
    \author[1]{Oliver Stevens}
    \author[1,3]{Kevin Lam}
    \author[4]{Katherine Kripke}
    % \author[1]{Rachel Esra}
    % \author[5]{Ian Wanyeki}
    % \author[5]{Lycias Zembe}
    % \author[1]{Jeffrey W. Eaton}

    % % author affiliations
    % \affil[1]{\emph{Imperial College London, London, United Kingdom}} \\
    % \affil[2]{\emph{Joint Centre for Excellence in Environmental Intelligence, Uniersity of Exeter and Met Office}} \\
    % \affil[3]{\emph{Department of Statistics, University of British Columbia}} \\
    % \affil[4]{\emph{Avenir Health, Takoma Park, MD, USA}} \\
    % \affil[5]{\emph{Join United Nations Programme on HIV/AIDS (UNAIDS)}} \\

    \newpage
  }
#+end_src
